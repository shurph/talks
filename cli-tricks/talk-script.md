# ОЖИДАНИЕ
Всем, кто присоединился, привет.
Отправьте пожалуйста в чат плюсик, если вам всё слышно и видно.
Давайте чуть-чуть подождём, пока подтянуться остальные желающие послушать сегодняшний спич.
Наверное, пришедшие, уже читали тизер этого мероприятия и с большего представляют, о чем будет идти речь. Мы будем разбирать некоторые примеры использования консольных утилит в линуксе, точнее в юникс-подобных операционных системах. И разбирать мы это будем на примере конкретной задачи. Чуть позже я скину ссылку на репозиторий, где лежат те файлы, которые мы сегодня будем обрабатывать.

Пока мы ждём опаздывающих, давайте чуть познакомимся. Напишите в чат, кто вы, чем занимаетесь, как дошли до жизни такой.
Вы пишите, а я же чуть-чуть расскажу о себе.
Вы уже знаете, что меня зовут Николай. И, очевидно, я работаю в компании itechart.
Моё направление технических интересов - это бекенд, в частности питон, в некоторой степень фронтент, также девопс (хотя многие не согласятся, что девопс - это что-то техническое).  И сквозь все эти мои интересы проходит моя увлеченность консолью и линуксом. Точнее даже не линуксом, а юниксподобными средами. Но давайте договоримся, что когда я говорю линукс сегодня - я имею в виду юниксподобные среды.

Вообще, у кого уже есть опыт с линуксом? Как начинали?

Свой первый опытом с линуксом я получил ещё в школе, более 15 лет назад, когда пытался установить пиратскую копию линукса (мандрейк). С первого раза ничего не получилось, потому что пираты что-то попортили. Но это очень старая история и вам, скорее всего не интересная.

Окей, мы выждали уже довольно много. Давайте всё-же начинать.

# ВСТУПЛЕНИЕ

И так, мы с вами собрались здесь, чтобы понять, что можно делать с помощью консоли в линуксе и, возможно, научится делать что-то самостоятельно.

Кто-то, кто только знакомится с консолью, возможно осознает, что с помощи консоли можно делать много чего полезного. Автоматизировать какую-то рутину, ускорять своё взаимодействие с системой.

Кто-то же, кто уже довольно опытен, уверенно чувствует себя в консоли, сможет в моём докладе приметить какие-то интересные, не самые распространённые инструменты. 

Чуть-чуть про организационные моменты: мну будет трудновато одновременно говорить, писать какие-то вещи в консоли и ещё и следить за чатом.
Поэтому было бы очень хорошо, если бы вы отправляли свои вопросы в чат ближе к концу доклада, а не в процессе. 

Но давайте вернёмся к коснольным трюкам.

# Практическая задача

Мне кажется, рассматривать какие-то консольные практики гораздно приятнее, да и эффективнее, на какой-то практической задаче.
Такая у меня есть для вас.

Те из вас, кто сейчас смотрят в монитор, уже успели ознакомиться с задачей. Для тех же, кто предпочитает смотреть видео в режиме подкаста, дам несколько поясненний.

Так получилось, что я сейчас довольно активно учавствую в минских митапах, посвящённых питону. На встречах этих производятся видеозаписи докладов. Эти видеозаписи выкладываются на ютуб. Так продолжается аж с 2013 года. За это время накопилось более 130 видеозаписей.
Чтобы популизировать наше минское питоне движение, нужно было разместить все эти видео не только на ютубе, но и на специализированном сайте для питонистов - pyvideo.org.
Pyvideo.org предоставляет специальный скрипт, который выдирает записи с ютуба. Однако, скрипт этот сработал не оптимально для конкретно нашего случая --- нужно было сделать много изменений в получившихся JSON файлах: для начала переименовать сами файлы адекватно, потом причесать содержимое этих JSON файлов.
Если это всё делать вручную, то даже только переименовать 130 файлов - это час времени. Если не больше.
Редактирование же JSON-ов вручную - это много часов работы, плюс возможные ошибки из-за невнимательности в процессе.

Нужно бы как-то автоматизировать этот процесс.
Но расчехлять среду разработки и на каком-то языке программирования проект --- это какой-то оверкилл, как по мне. Тем более, что у нас пока нет чёткого представления, что именно и как именно нам нужно трансформировать.

А вот накидать пару тройку команд в консоли --- вот это любо!

# Концепции
Работая с консолью, хорошо бы понить некоторые важные вещи.
Я из назвал концептии.
Во первых, вы можете обильно смазывать свою консольные трюки регулярными выражениями. Иногда регулярки создают проблемы, но у нас здесь будет одноразовый код, который после одного-двух использований будет выброшен. Поэтому не стесняйтесь пользоваться регулярками.

Во-вторых, в линуксовой консоли есть такая мощная концепция, как конвейеры, они же --- пайпы. С помощью них можно создавать очень мощные цепочки для обработки данных.

Ну и, конечно же, циклы и переменные. Если вы пользуетесь дефолтной линуксовой консолью, то в качестве командной оболочки у вас будет БАШ.
БАШ поддерживает работу с циклами, с переменными, да  и многоими другими штуками, которые свойственны языкам программирования.


# КОД

Вы, наверное, устали слушать всякие теоретические речи и хочете посмотреть на что-то прикладное

ls
Вот наши файлы

ls|wc
Их у нас приблизительно вот столько

Я хотел скинуть ссылку на репозиторий с этими файлами ближе к концу презентации, но давайте я прямо сейчас скину
%% дай мне ссылку номер 13

Можете в параллель с просмотром доклада попробовать самостоятельно что-то поделать с репозиторием
pwd

Как видите, мы работаем с каталогом minsk-python-meetup/videos

# СЛАЙД
и так, давайте определимся, что мы хотим сделать с именами файлов
Во всех именах прослеживается паттерн
---- импровизация... ------

В линуксе есть утилита rename, которая позволяет массово переименовывать файлы. Она поддерживает работу с регулярными выражениями

rename 's/-python-meetup//g' *json

Вот, что-то уже сделали.
Но этой штуке не хватает интерактивности, хотелось бы чуть больше интерактивности.

И для этого у нас есть другой инструмент --- vidir
Из названия можно догадаться, что для интерактивности будет использоваться VIM как текстовый редактор и результаты работы в виме приведут к модификации директории.
vidir
[0-9]

# СЛАЙД

смотрите, у нас прослеживается во всех строках некий паттерн. часть его мы уже видели на предыдущих слайдах


**## 1: ##** %s/\t.\/\(.\+\)-\([0-9]\{2\}\)-\([0-9]\{2\}\)-\([0-9]\{2,4\}\)/\t.\/\4-\3-\2-\1/g
**## 2: ##** %s/\t.\/\(.\+\)-\([0-9]\{2,4\}\)\(.json\)/\t.\/\2-\1\3/g

Удалим лишний файл:

git rm python-meetup-2-goda.json

Сохраним проделанную работу в гите, чтобы если мы что-то не так сделаем на следующих этапах, было куда откатиться

git add . ; git commit -m s1

Возьмём имя какого-нибудь одного файла

ls | head -1

Кстати, заметьте, мы уже не впервый раз импользуем конвейеры

# СЛАЙД

давайте на этом этапе поговорим чуть подробнее про конвейеры

------

и так, вернемся к нашим файлам

cat `ls |head -1`
jq '.' `ls |head -1`
FN=`ls |head -1`
jq '.title' *json
jq '. + {recorded:.title,speakers:[.title]}' $FN
jq '. + {recorded:.title,speakers:[.title]}' $FN > $FN

# СЛАЙД :: конвейеры и SPONGE

jq '. + {recorded:.title,speakers:[.title]}' $FN | sponge $FN

# СЛАЙД :: ЦИКЛЫ


**## 3: ##** for FN in *json ; do jq '. + {recorded:.title,speakers:[.title]}' $FN | sponge $FN ; done
git add . ; git commit -m s2
**## 4: ##** cat $FN | sed -e 's#\("title": "\)\([^/]\+\)/[^"]\+#\1\2#g'
**## 5: ##** cat $FN | sed -e 's#\("title": "\)\([^/]\+\)/[^"]\+#\1\2#g' | sponge $FN
**## 6: ##** for FN in *json; do cat $FN | sed -e 's#\("title": "\)\([^/]\+\)/[^"]\+#\1\2#g' | sponge $FN; done
git add . ; git commit -m s3
**## 7: ##** cat *json | grep recorded | sed 's=\("recorded": "\)[^[]\+=\1=g'
**## 8: ##** cat *json | grep recorded | sed 's=\("recorded": "\)[^[]\+=\1=g' | sed 's=\("recorded": "\)[^0-9]\+\([0-9\.]\+\)]=\1\2=g'
**## 9: ##** cat *json | grep recorded | sed 's=\("recorded": "\)[^[]\+=\1=g' | sed 's=\("recorded": "\)[^0-9]\+\([0-9\.]\+\)]=\1\2=g' | sed 's=recorded[^0-9]\+\([0-9]\+\)\.\([0-9]\+\)\.\([0-9]\+\)=recorded": "\3-\2-\1=g'
**## 10: ##** for FN in *json; do cat $FN | sed 's=\("recorded": "\)[^[]\+=\1=g' | sed 's=\("recorded": "\)[^0-9]\+\([0-9\.]\+\)]=\1\2=g' | sed 's=recorded[^0-9]\+\([0-9]\+\)\.\([0-9]\+\)\.\([0-9]\+\)=recorded": "\3-\2-\1=g' | sponge $FN; done 

вот мы уже разобрались с TITLE и с RECORDED. конечно, кое-что придётся поправить ещё руками, но большую часть работы мы слегка автоматизировали.

ещё осталось разобраться с секцией SPEAKERS. но, мне кажется хорошей идеей оставить эту часть работы вам в качестве домашнего задания. если вы конечно в этом заинтересованы.

давайте я скину вам в чат ссылку на список тех команд, которые я применял в процессе доклада:

%% покажи ссылку 14



# СЛАЙД: последний слайд

мы уже почти подошли к концу доклада
задавайте ваши вопросы в чат, буду стараться на них ответить
у ютуба может быть рассинхрон, поэтому пока я жду ваши вопросы, давайте я быстро перечислю те утилиты, которые мы сегодня использовали.





**## 11: ##** for FN in *json; do jq -S '. +{speaker:.speakers[0]}' $FN | sponge $FN ; done
**## 12: ##** cat *json | grep speaker\"| sed 's=\(speaker": "\)[^/]*/[ ]*\([^/^"^[]\+\)[^"]\+=\1\2='



